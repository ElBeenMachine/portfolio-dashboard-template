name: CI - Release

on:
    push:
        branches: [production]

jobs:
    get_project_version:
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v3
            - name: Use Node.js 23
              uses: actions/setup-node@v3
              with:
                  node-version: 23
                  cache: "npm"
            - name: Get project version
              run: |
                  npm install
                  export VERSION=$(node -p "require('./package.json').version")
                  echo "VERSION=$VERSION" >> variables.env
            - uses: actions/upload-artifact@v3
              with:
                  name: variables.env
                  path: variables.env

    create_release:
        runs-on: ubuntu-latest
        needs: [get_project_version]
        steps:
            - uses: actions/checkout@v3
            - name: Download release-cli action
              uses: gr2m/release-action@v1.4.0
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
            - name: Create Release
              run: |
                  echo "Creating release $VERSION"
            - name: Create release on GitHub
              uses: gr2m/release-action@v1.4.0
              env:
                  VERSION: ${{ needs.get_project_version.outputs.VERSION }}
              with:
                  tag_name: ${{ needs.get_project_version.outputs.VERSION }}
                  description: |
                      This is the release for version ${{ needs.get_project_version.outputs.VERSION }}
                  ref: ${{ github.sha }}
                  assets: |
                      {
                        "links": [
                          { "name": "Docker Image", "url": "https://hub.docker.com/r/$DOCKER_USER/portfolio-dashboard" }
                        ]
                      }
