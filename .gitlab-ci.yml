# Define variables and default images
variables:
    NODE_IMAGE: node:23-alpine
    DOCKER_IMAGE: docker:stable
    PROJECT_NAME: portfolio-dashboard

# Define the stages
stages:
    - documentation
    - test
    - build
    - release
    - deploy

# Always run pipeline so that when no pipeline is run, the pipeline is still created
.always_run:
    stage: test
    script:
        - echo "This is a dummy job to ensure the pipeline is always run"
    rules:
        # Run when other requirements are not met
        - if: $CI_COMMIT_BRANCH != "main" && $CI_COMMIT_BRANCH != "production" && $CI_COMMIT_BRANCH != "pre-production" && $CI_COMMIT_BRANCH !~ /^feature\/.*$/ && $CI_COMMIT_BRANCH !~ /^fix\/.*$/ && $CI_COMMIT_BRANCH !~ /^docs\/.*$/

# Deploy the documentation
deploy_documentation:
    stage: documentation
    script:
        - echo "This is where I would deploy the documentation once configured"
    rules:
        - if: $CI_COMMIT_BRANCH == "main"
        - changes:
              - docs/**/*

# Lint the code
lint_code:
    stage: test
    image: $NODE_IMAGE
    script:
        - npm install
        - npm run lint
    rules:
        - if: $CI_COMMIT_BRANCH =~ /^feature\/.*$/
        - if: $CI_COMMIT_BRANCH =~ /^fix\/.*$/

# Run unit tests
unit_tests:
    stage: test
    image: $NODE_IMAGE
    script:
        - npm install
        - npm test
    rules:
        - if: $CI_COMMIT_BRANCH =~ /^feature\/.*$/
        - if: $CI_COMMIT_BRANCH =~ /^fix\/.*$/

# Build the project for testing
build_project:
    stage: build
    image: $DOCKER_IMAGE
    services:
        - docker:stable-dind
    script:
        - docker build -t $PROJECT_NAME:testing .
    rules:
        - if: $CI_COMMIT_BRANCH == "main"

# Get the project version for release
get_release_version:
    stage: release
    image: node:23-alpine
    script:
        # Check to see if project tag already exists
        - |
            if docker manifest inspect "$DOCKER_USER/$PROJECT_NAME:$TAG" > /dev/null 2>&1; then
                echo "Docker image $DOCKER_USER/$PROJECT_NAME:$TAG already exists."
                exit 1
            else
                echo "Docker image $DOCKER_USER/$PROJECT_NAME:$TAG does not exist, passing tag to next job."
            fi

        # Get the project version
        - export VERSION=$(node -p "require('./package.json').version")
        - echo "VERSION=$VERSION" >> variables.env
    artifacts:
        reports:
            dotenv: variables.env
    rules:
        - if: $CI_COMMIT_BRANCH == "pre-production"

# Build the project for release
build_release:
    needs:
        - job: get_release_version
          artifacts: true
    stage: release
    image: $DOCKER_IMAGE
    services:
        - docker:stable-dind
    before_script:
        - echo "$DOCKER_TOKEN" | docker login -u $DOCKER_USER --password-stdin
    script:
        - docker buildx create --use
        - docker buildx build --platform linux/amd64,linux/arm64 -t $DOCKER_USER/$PROJECT_NAME:$VERSION -t $DOCKER_USER/$PROJECT_NAME:latest --push .
    rules:
        - if: $CI_COMMIT_BRANCH == "pre-production"

# TODO: Automatically generate release notes

# Create a release
create_release:
    needs:
        - job: get_release_version
          artifacts: true
        - job: build_release
    stage: release
    image: registry.gitlab.com/gitlab-org/release-cli:latest
    script:
        - echo "Creating release $VERSION"
    release:
        name: Release $VERSION
        tag_name: $VERSION
        description: |
            This is the release for version $VERSION
        ref: $CI_COMMIT_SHA
        assets:
            links:
                - name: "Docker Image"
                  url: https://hub.docker.com/r/$DOCKER_USER/portfolio-dashboard
    rules:
        - if: $CI_COMMIT_BRANCH == "pre-production"

# Get the proejct version for deployment
get_deploy_version:
    stage: deploy
    image: node:23-alpine
    script:
        - export VERSION=$(node -p "require('./package.json').version")
        - echo "VERSION=$VERSION" >> variables.env
    artifacts:
        reports:
            dotenv: variables.env
    rules:
        - if: $CI_COMMIT_BRANCH == "production"
# TODO: Use kubernetes spec to deploy to production environment
