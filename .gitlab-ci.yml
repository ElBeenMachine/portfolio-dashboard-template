# Define the stages
stages:
    - release

# Get the project version
get_project_version:
    stage: release
    image: node:23-alpine
    script:
        - export VERSION=$(node -p "require('./package.json').version")
        - echo "VERSION=$VERSION" >> variables.env
    before_script: []
    services: []
    artifacts:
        reports:
            dotenv: variables.env

# Create a release
create_release:
    stage: release
    needs:
        - job: get_project_version
          artifacts: true

    image: curlimages/curl:latest
    script:
        # Create GitLab release
        - |
            curl --header "PRIVATE-TOKEN: $GITLAB_TOKEN" --header "Content-Type: application/json" \
              --data "{
                \"name\": \"Release $VERSION\",
                \"tag_name\": \"$VERSION\",
                \"description\": \"Release version $VERSION\",
                \"assets\": {
                  \"links\": [
                    {
                      \"name\": \"Docker Image\",
                      \"url\": \"https://hub.docker.com/r/$DOCKER_USERNAME/portfolio-dashboard"
                    }
                  ]
                }
              }" \
              "https://gitlab.com/api/v4/projects/$CI_PROJECT_ID/releases"
