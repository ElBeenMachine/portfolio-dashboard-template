# Release for arm64 architecture
release_arm64:
    needs:
        - job: test
        - job: build_arm64
          artifacts: true
        - job: get_version
          artifacts: true
    stage: release
    before_script:
        - until docker info; do sleep 1; done
        - echo "$AZURECR_PASSWORD" | docker login $AZURECR_HOST -u $AZURECR_USER --password-stdin
    script:
        - docker load < builds/$PROJECT_NAME:$CI_COMMIT_SHA-arm64.tar
        - docker tag $PROJECT_NAME:$CI_COMMIT_SHA-arm64 $IMAGE_NAME:$TAG-arm64
        - docker rmi $PROJECT_NAME:$CI_COMMIT_SHA-arm64
        - docker tag $IMAGE_NAME:$TAG-arm64 $IMAGE_NAME:latest-arm64
        - docker push $IMAGE_NAME:$TAG-arm64

# Release for amd64 architecture
release_amd64:
    needs:
        - job: test
        - job: build_amd64
          artifacts: true
        - job: get_version
          artifacts: true
    stage: release
    before_script:
        - until docker info; do sleep 1; done
        - echo "$AZURECR_PASSWORD" | docker login $AZURECR_HOST -u $AZURECR_USER --password-stdin
    script:
        - docker load < builds/$PROJECT_NAME:$CI_COMMIT_SHA-amd64.tar
        - docker tag $PROJECT_NAME:$CI_COMMIT_SHA-amd64 $IMAGE_NAME:$TAG
        - docker rmi $PROJECT_NAME:$CI_COMMIT_SHA-amd64
        - docker tag $IMAGE_NAME:$TAG-amd64 $IMAGE_NAME:latest
        - docker push $IMAGE_NAME:$TAG-amd64
